.PHONY: build test clean run help docker docker-build docker-up docker-down deploy install fmt vet lint

# Variables
BINARY_NAME=goleapai
GO=go
VERSION=$(shell git describe --tags --always --dirty 2>/dev/null || echo "dev")
GOFLAGS=-ldflags="-w -s -X main.version=$(VERSION)" -trimpath
DOCKER_IMAGE=$(BINARY_NAME):latest

# Colors
GREEN=\033[0;32m
YELLOW=\033[1;33m
NC=\033[0m

help: ## Show help
	@echo "GoLeapAI - Makefile Commands"
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | awk 'BEGIN {FS = ":.*?## "}; {printf "  %-20s %s\n", $$1, $$2}'

build: ## Build backend binary
	@echo "Building goleapai..."
	@mkdir -p bin
	CGO_ENABLED=1 $(GO) build $(GOFLAGS) -o ./bin/$(BINARY_NAME) ./cmd/backend

build-linux: ## Build for Linux production
	@echo "Building for Linux..."
	@mkdir -p bin
	CGO_ENABLED=1 GOOS=linux GOARCH=amd64 $(GO) build \
		-ldflags="-w -s -X main.version=$(VERSION) -extldflags '-static'" \
		-tags="sqlite_omit_load_extension" \
		-o ./bin/$(BINARY_NAME) ./cmd/backend

build-tui: ## Build TUI
	@mkdir -p bin
	CGO_ENABLED=0 $(GO) build $(GOFLAGS) -o ./bin/goleapai-tui ./cmd/tui

test: ## Run tests
	$(GO) test -v ./...

test-coverage: ## Run tests with coverage
	$(GO) test -v -race -coverprofile=coverage.out ./...
	$(GO) tool cover -html=coverage.out -o coverage.html

clean: ## Clean build artifacts
	rm -rf bin/ data/*.db coverage.out coverage.html

run: build ## Run backend
	@mkdir -p data
	./bin/$(BINARY_NAME) serve

run-dev: ## Run in development mode
	@mkdir -p data
	$(GO) run ./cmd/backend serve --log-level debug

fmt: ## Format code
	$(GO) fmt ./...
	gofmt -s -w .

vet: ## Run go vet
	$(GO) vet ./...

lint: ## Run linter
	golangci-lint run ./...

tidy: ## Tidy go modules
	$(GO) mod tidy
	$(GO) mod verify

docker-build: ## Build Docker image
	@echo "Building Docker image..."
	docker build -t $(DOCKER_IMAGE) .

docker-up: ## Start Docker Compose services
	@echo "Starting Docker services..."
	docker-compose up -d

docker-down: ## Stop Docker Compose services
	@echo "Stopping Docker services..."
	docker-compose down

docker-logs: ## View Docker logs
	docker-compose logs -f

docker-ps: ## List Docker containers
	docker-compose ps

docker: docker-build docker-up ## Build and start Docker services

deploy: ## Run deployment script
	@echo "Running deployment..."
	./scripts/deploy.sh deploy

install: build-linux ## Install to system
	@echo "Installing to system..."
	sudo ./scripts/install.sh

backup: ## Create backup
	@echo "Creating backup..."
	./scripts/backup.sh

check: fmt vet test ## Run all checks
	@echo "All checks passed!"

.DEFAULT_GOAL := help
